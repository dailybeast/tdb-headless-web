---
import type { ReferenceBlock, Article } from '@/lib/types';
import { api } from '@/lib/api';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Skeleton } from '@/components/ui/skeleton';

interface Props {
  block: ReferenceBlock;
  class?: string;
}

const { block, class: className } = Astro.props;

// Try to fetch the referenced story
let relatedStory: Article | null = null;
let error = false;

try {
  if (block.referent?.id && block.referent?.type === 'story') {
    const response = await api.getArticle(block.referent.id, { by: 'id' });
    if (response.data) {
      relatedStory = response.data;
    }
  }
} catch (err) {
  console.error('Failed to fetch related story:', block.referent?.id, err);
  error = true;
}

// Helper functions
function getImageUrl(article: Article): string {
  if (article.promo_items?.basic?.url) {
    return article.promo_items.basic.url;
  }
  if (article.promo_items?.basic?.additional_properties?.originalUrl) {
    return article.promo_items.basic.additional_properties.originalUrl;
  }
  return '';
}

function getArticleUrl(article: Article): string {
  return article.website_url || article.canonical_url || `/article/${article._id}`;
}
---

<aside class={`my-8 ${className || ''}`}>
  {relatedStory ? (
    <a href={getArticleUrl(relatedStory)} class="block group">
      <Card className="overflow-hidden hover:shadow-lg transition-shadow">
        <div class="grid md:grid-cols-3 gap-4">
          {getImageUrl(relatedStory) && (
            <div class="md:col-span-1">
              <div class="aspect-video md:aspect-square overflow-hidden bg-muted">
                <img 
                  src={getImageUrl(relatedStory)} 
                  alt={relatedStory.headlines?.basic || 'Related article'}
                  class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                  loading="lazy"
                />
              </div>
            </div>
          )}
          <div class={`${getImageUrl(relatedStory) ? 'md:col-span-2' : 'md:col-span-3'}`}>
            <CardHeader>
              <div class="text-xs text-primary font-medium uppercase tracking-wide mb-2">
                Related Story
              </div>
              <CardTitle className="text-lg font-bold font-druk leading-tight group-hover:text-primary transition-colors">
                {relatedStory.headlines?.basic || 'Related Article'}
              </CardTitle>
              {relatedStory.description?.basic && (
                <CardDescription className="text-sm line-clamp-2">
                  {relatedStory.description.basic}
                </CardDescription>
              )}
            </CardHeader>
            {relatedStory.credits?.by?.[0] && (
              <CardContent className="pt-0">
                <div class="text-xs text-muted-foreground">
                  By {relatedStory.credits.by[0].name}
                </div>
              </CardContent>
            )}
          </div>
        </div>
      </Card>
    </a>
  ) : (
    <Card>
      <CardHeader>
        <div class="text-xs text-primary font-medium uppercase tracking-wide mb-2">
          Related Coverage
        </div>
        {error ? (
          <div class="space-y-3">
            <Skeleton className="h-5 w-3/4" />
            <Skeleton className="h-4 w-full" />
            <Skeleton className="h-4 w-2/3" />
          </div>
        ) : (
          <div>
            <CardTitle className="text-lg font-medium">Related Story</CardTitle>
            <CardDescription>Continue reading for more coverage on this topic.</CardDescription>
          </div>
        )}
      </CardHeader>
    </Card>
  )}
</aside>